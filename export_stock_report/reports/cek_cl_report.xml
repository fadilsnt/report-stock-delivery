<odoo>
    <template id="report_cek_cl">
        <t t-call="web.external_layout">
            <t t-if="kategori == 'LOKAL'">
                <t t-call="export_stock_report.report_cek_cl_lokal"/>
            </t>
            <t t-elif="kategori == 'EXPORT'">
                <t t-call="export_stock_report.report_cek_cl_export"/>
            </t>
        </t>
    </template>

    <!-- ================= LOKAL ================= -->
    <template id="report_cek_cl_lokal">
        <main class="page">

            <h3 style="text-align:center;">
                TOTAL STOK ARANG LOKAL <br/>
                Per tanggal
                <t t-esc="time.strftime('%d-%m-%Y', time.strptime(str(docs.end_date), '%Y-%m-%d'))"/>
            </h3>

            <t t-foreach="report_data" t-as="line">
                <h4><t t-esc="line['product']"/></h4>

                <table class="report-table">
                    <tbody>
                        <t t-foreach="line['warehouse_lines']" t-as="wh_line">
                            <tr>
                                <td><t t-esc="wh_line['warehouse']"/></td>

                                <t t-foreach="line['uoms']" t-as="u">
                                    <!-- BOX -->
                                    <td>
                                        <t t-esc="('{:,.0f}'.format(
                                            wh_line['uoms'].get(u, {}).get('box', 0)
                                        )).replace(',', '.')"/>
                                    </td>

                                    <!-- KG -->
                                    <td>
                                        <t t-esc="('{:,.0f}'.format(
                                            wh_line['uoms'].get(u, {}).get('kg', 0)
                                        )).replace(',', '.')"/>
                                    </td>
                                </t>

                                <!-- TOTAL -->
                                <td>
                                    <t t-esc="('{:,.0f}'.format(
                                        wh_line['total']
                                    )).replace(',', '.')"/>
                                </td>
                            </tr>
                        </t>
                    </tbody>
                </table>
            </t>
        </main>
    </template>

    <!-- ================= EXPORT ================= -->
    <template id="report_cek_cl_export">
        <main class="page" style="font-size:12px;">

            <h3 style="text-align:center;">
                Report Total Box Export <br/>
                Dalam satuan CONTAINER <br/>
                Per tanggal
                <t t-esc="time.strftime('%d-%m-%Y', time.strptime(str(docs.end_date), '%Y-%m-%d'))"/>
            </h3>

            <t t-set="data" t-value="report_data[0]"/>
            <t t-set="boxes" t-value="data['boxes']"/>
            <t t-set="grades" t-value="data['grades']"/>
            <t t-set="wh_lines" t-value="data['warehouse_lines']"/>

            <table style="width:100%; border-collapse: collapse;">

                <t t-foreach="boxes" t-as="box">
                    <t t-foreach="grades" t-as="grade">

                        <t t-set="row_total"
                           t-value="sum([wh['boxes'].get(box, {}).get(grade, 0) for wh in wh_lines])"/>

                        <tr t-if="row_total > 0">
                            <td><t t-esc="box"/></td>
                            <td><t t-esc="grade"/></td>

                            <t t-foreach="wh_lines" t-as="wh">
                                <td style="text-align:right;">
                                    <t t-esc="('{:,.2f}'.format(
                                        wh['boxes'].get(box, {}).get(grade, 0) or 0
                                    )).replace(',', 'X').replace('.', ',').replace('X', '.')"/>
                                </td>
                            </t>

                            <td style="text-align:right;">
                                <t t-esc="('{:,.2f}'.format(
                                    row_total
                                )).replace(',', 'X').replace('.', ',').replace('X', '.')"/>
                            </td>
                        </tr>

                    </t>

                    <!-- TOTAL PER BOX -->
                    <t t-set="box_total"
                       t-value="sum([wh['boxes'].get(box, {}).get(g, 0) for wh in wh_lines for g in grades])"/>

                    <tr t-if="box_total > 0" style="font-weight:bold;">
                        <td colspan="2">TOTAL BOX <t t-esc="box"/></td>

                        <t t-foreach="wh_lines" t-as="wh">
                            <td style="text-align:right;">
                                <t t-esc="('{:,.2f}'.format(
                                    sum([wh['boxes'].get(box, {}).get(g, 0) for g in grades])
                                )).replace(',', 'X').replace('.', ',').replace('X', '.')"/>
                            </td>
                        </t>

                        <td style="text-align:right;">
                            <t t-esc="('{:,.2f}'.format(
                                box_total
                            )).replace(',', 'X').replace('.', ',').replace('X', '.')"/>
                        </td>
                    </tr>
                </t>

                <!-- FOOTER -->
                <tr style="font-weight:bold;">
                    <td colspan="2">TOTAL PER PABRIK</td>

                    <t t-foreach="wh_lines" t-as="wh">
                        <td style="text-align:right;">
                            <t t-esc="('{:,.2f}'.format(
                                wh['total'] or 0
                            )).replace(',', 'X').replace('.', ',').replace('X', '.')"/>
                        </td>
                    </t>

                    <td style="text-align:right;">
                        <t t-esc="('{:,.2f}'.format(
                            data['grand_total'] or 0
                        )).replace(',', 'X').replace('.', ',').replace('X', '.')"/>
                    </td>
                </tr>

            </table>
        </main>
    </template>
</odoo>
